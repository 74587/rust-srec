name: strev Release

on:
  push:
    tags:
      - "strev-v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  CARGO_INCREMENTAL: 0

jobs:
  check-and-test:
    name: Check and Test
    runs-on: ubuntu-latest
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
    steps:
      - uses: actions/checkout@v6
      - uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.13.0"
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: taiki-e/install-action@nextest
      - uses: ./.github/actions/setup-protoc
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci
      - name: Check
        run: cargo check -p strev --locked --features tls-native-fallback
      - name: Clippy
        run: cargo clippy -p strev --locked --features tls-native-fallback -- -D warnings
      - name: Test
        run: cargo nextest run -p strev --locked --features tls-native-fallback --no-tests=pass
      - name: Doctests
        run: cargo test -p strev --locked --doc --features tls-native-fallback
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  build:
    needs: check-and-test
    uses: ./.github/workflows/build-binaries.yml
    with:
      packages: '-p strev'
      binaries: '["strev"]'
      need_protoc: true

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
